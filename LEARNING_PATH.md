# MediaMTX é¡¹ç›®å­¦ä¹ è·¯å¾„æŒ‡å—

## ğŸ¯ å­¦ä¹ ç›®æ ‡
é€šè¿‡ç³»ç»Ÿæ€§çš„ä»£ç é˜…è¯»ï¼Œç†è§£MediaMTXä½œä¸ºæµåª’ä½“æœåŠ¡å™¨çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼Œä»å¯åŠ¨åˆ°å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„å…¨è¿‡ç¨‹ã€‚

## ğŸ“ å­¦ä¹ èµ·ç‚¹ï¼šmain.go

### ç¬¬ä¸€æ­¥ï¼šç¨‹åºå…¥å£åˆ†æ
**æ–‡ä»¶ä½ç½®**: `main.go`

```go
func main() {
    s, ok := core.New(os.Args[1:])  // åˆ›å»ºCoreå®ä¾‹
    if !ok {
        os.Exit(1)
    }
    s.Wait()  // ç­‰å¾…ç¨‹åºç»“æŸ
}
```

**å­¦ä¹ è¦ç‚¹**:
- ç¨‹åºå¦‚ä½•è§£æå‘½ä»¤è¡Œå‚æ•°
- Coreç»“æ„ä½“çš„åˆ›å»ºè¿‡ç¨‹
- ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

**è®¾ç½®æ–­ç‚¹**: `main.go:10` (core.Newè°ƒç”¨)

---

## ğŸ”§ ç¬¬äºŒæ­¥ï¼šCoreåˆå§‹åŒ–æµç¨‹

### 2.1 Coreç»“æ„ä½“åˆ†æ
**æ–‡ä»¶ä½ç½®**: `internal/core/core.go:77-105`

```go
type Core struct {
    ctx             context.Context
    ctxCancel       func()
    confPath        string
    conf            *conf.Conf
    logger          *logger.Logger
    externalCmdPool *externalcmd.Pool
    authManager     *auth.Manager
    metrics         *metrics.Metrics
    pprof           *pprof.PPROF
    recordCleaner   *recordcleaner.Cleaner
    playbackServer  *playback.Server
    pathManager     *pathManager
    rtspServer      *rtsp.Server
    rtspsServer     *rtsp.Server
    rtmpServer      *rtmp.Server
    rtmpsServer     *rtmp.Server
    hlsServer       *hls.Server
    webRTCServer    *webrtc.Server
    srtServer       *srt.Server
    api             *api.API
    confWatcher     *confwatcher.ConfWatcher
    // ...
}
```

**å­¦ä¹ è¦ç‚¹**:
- ç†è§£æ¯ä¸ªç»„ä»¶çš„èŒè´£
- ç»„ä»¶é—´çš„ä¾èµ–å…³ç³»
- æ•´ä½“æ¶æ„è®¾è®¡

**è®¾ç½®æ–­ç‚¹**: `internal/core/core.go:108` (Newå‡½æ•°å¼€å§‹)

### 2.2 é…ç½®åŠ è½½æµç¨‹
**æ–‡ä»¶ä½ç½®**: `internal/core/core.go:140-150`

```go
p.conf, p.confPath, err = conf.Load(cli.Confpath, defaultConfPaths, tempLogger)
```

**å­¦ä¹ è¦ç‚¹**:
- é…ç½®æ–‡ä»¶å¦‚ä½•è¢«åŠ è½½å’Œè§£æ
- é»˜è®¤é…ç½®çš„å¤„ç†
- é…ç½®éªŒè¯æœºåˆ¶

**è®¾ç½®æ–­ç‚¹**: `internal/conf/conf.go` (Loadå‡½æ•°)

### 2.3 èµ„æºåˆ›å»ºæµç¨‹
**æ–‡ä»¶ä½ç½®**: `internal/core/core.go:234-362`

```go
err = p.createResources(true)
```

**å­¦ä¹ è¦ç‚¹**:
- å„ä¸ªæœåŠ¡å™¨ç»„ä»¶çš„åˆå§‹åŒ–é¡ºåº
- é”™è¯¯å¤„ç†æœºåˆ¶
- èµ„æºç®¡ç†ç­–ç•¥

**è®¾ç½®æ–­ç‚¹**: `internal/core/core.go:234` (createResourceså‡½æ•°)

---

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡å™¨å¯åŠ¨æµç¨‹

### 3.1 ä¸»äº‹ä»¶å¾ªç¯
**æ–‡ä»¶ä½ç½®**: `internal/core/core.go:170-220`

```go
func (p *Core) run() {
    defer close(p.done)
    
    // é…ç½®å˜æ›´ç›‘å¬
    confChanged := func() chan struct{} {
        if p.confWatcher != nil {
            return p.confWatcher.Watch()
        }
        return make(chan struct{})
    }()
    
    // ä¿¡å·å¤„ç†
    interrupt := make(chan os.Signal, 1)
    signal.Notify(interrupt, os.Interrupt)
    
    // ä¸»äº‹ä»¶å¾ªç¯
    for {
        select {
        case <-confChanged:
            // é…ç½®çƒ­é‡è½½
        case newConf := <-p.chAPIConfigSet:
            // APIé…ç½®æ›´æ–°
        case <-interrupt:
            // ä¼˜é›…å…³é—­
        case <-p.ctx.Done():
            // ä¸Šä¸‹æ–‡å–æ¶ˆ
        }
    }
}
```

**å­¦ä¹ è¦ç‚¹**:
- Goè¯­è¨€çš„å¹¶å‘æ¨¡å‹åº”ç”¨
- äº‹ä»¶é©±åŠ¨æ¶æ„
- ä¼˜é›…å…³é—­æœºåˆ¶

**è®¾ç½®æ–­ç‚¹**: `internal/core/core.go:170` (runå‡½æ•°å¼€å§‹)

---

## ğŸ“¡ ç¬¬å››æ­¥ï¼šåè®®æœåŠ¡å™¨å®ç°

### 4.1 RTSPæœåŠ¡å™¨ (é‡ç‚¹æ¨è)
**æ–‡ä»¶ä½ç½®**: `internal/servers/rtsp/`

**å­¦ä¹ è·¯å¾„**:
1. `server.go` - æœåŠ¡å™¨ä¸»é€»è¾‘
2. `conn.go` - è¿æ¥å¤„ç†
3. `session.go` - ä¼šè¯ç®¡ç†

**æ ¸å¿ƒæ¦‚å¿µ**:
- RTSPåè®®çŠ¶æ€æœº
- RTP/RTCPåª’ä½“ä¼ è¾“
- ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

**è®¾ç½®æ–­ç‚¹**: `internal/servers/rtsp/server.go` (Serverç»“æ„ä½“)

### 4.2 WebRTCæœåŠ¡å™¨
**æ–‡ä»¶ä½ç½®**: `internal/servers/webrtc/`

**å­¦ä¹ è·¯å¾„**:
1. `server.go` - WebRTCæœåŠ¡å™¨
2. `publisher.go` - å‘å¸ƒè€…å¤„ç†
3. `reader.go` - è¯»å–è€…å¤„ç†

**æ ¸å¿ƒæ¦‚å¿µ**:
- ICEè¿æ¥å»ºç«‹
- SDPåå•†è¿‡ç¨‹
- DTLSåŠ å¯†ä¼ è¾“

**è®¾ç½®æ–­ç‚¹**: `internal/servers/webrtc/server.go`

### 4.3 å…¶ä»–åè®®æœåŠ¡å™¨
- RTMP: `internal/servers/rtmp/`
- HLS: `internal/servers/hls/`
- SRT: `internal/servers/srt/`

---

## ğŸ›£ï¸ ç¬¬äº”æ­¥ï¼šè·¯å¾„ç®¡ç†ç³»ç»Ÿ

### 5.1 è·¯å¾„ç®¡ç†å™¨
**æ–‡ä»¶ä½ç½®**: `internal/core/path_manager.go`

**å­¦ä¹ è¦ç‚¹**:
- è·¯å¾„çš„åˆ›å»ºå’Œé”€æ¯
- å‘å¸ƒè€…å’Œè¯»å–è€…çš„ç®¡ç†
- æµåª’ä½“æ•°æ®çš„è·¯ç”±

**è®¾ç½®æ–­ç‚¹**: `internal/core/path_manager.go:64` (pathManagerç»“æ„ä½“)

### 5.2 è·¯å¾„æ•°æ®æµ
**æ–‡ä»¶ä½ç½®**: `internal/core/path.go`

**å­¦ä¹ è¦ç‚¹**:
- åª’ä½“æ•°æ®çš„æ¥æ”¶å’Œè½¬å‘
- ç¼“å†²åŒºç®¡ç†
- å¤šåè®®è½¬æ¢

---

## ğŸ” ç¬¬å…­æ­¥ï¼šè®¤è¯å’Œæƒé™ç³»ç»Ÿ

### 6.1 è®¤è¯ç®¡ç†å™¨
**æ–‡ä»¶ä½ç½®**: `internal/auth/`

**å­¦ä¹ è¦ç‚¹**:
- å¤šç§è®¤è¯æ–¹å¼å®ç°
- æƒé™éªŒè¯æœºåˆ¶
- JWTä»¤ç‰Œå¤„ç†

**è®¾ç½®æ–­ç‚¹**: `internal/auth/manager.go`

---

## ğŸ“Š ç¬¬ä¸ƒæ­¥ï¼šAPIå’Œç›‘æ§ç³»ç»Ÿ

### 7.1 RESTful API
**æ–‡ä»¶ä½ç½®**: `internal/api/`

**å­¦ä¹ è¦ç‚¹**:
- HTTPè·¯ç”±è®¾è®¡
- JSONåºåˆ—åŒ–
- é…ç½®çƒ­æ›´æ–°

**è®¾ç½®æ–­ç‚¹**: `internal/api/api.go:146` (è·¯ç”±è®¾ç½®)

### 7.2 æŒ‡æ ‡ç›‘æ§
**æ–‡ä»¶ä½ç½®**: `internal/metrics/`

**å­¦ä¹ è¦ç‚¹**:
- Prometheusæ ¼å¼æŒ‡æ ‡
- æ€§èƒ½æ•°æ®æ”¶é›†
- ç›‘æ§ç«¯ç‚¹å®ç°

---

## ğŸ¬ ç¬¬å…«æ­¥ï¼šå½•åˆ¶å’Œå›æ”¾ç³»ç»Ÿ

### 8.1 å½•åˆ¶åŠŸèƒ½
**æ–‡ä»¶ä½ç½®**: `internal/recorder/`

**å­¦ä¹ è¦ç‚¹**:
- åª’ä½“æ–‡ä»¶æ ¼å¼å¤„ç†
- åˆ†æ®µå½•åˆ¶ç­–ç•¥
- å­˜å‚¨ç®¡ç†

### 8.2 å›æ”¾åŠŸèƒ½
**æ–‡ä»¶ä½ç½®**: `internal/playback/`

**å­¦ä¹ è¦ç‚¹**:
- HTTPæµåª’ä½“æœåŠ¡
- æ—¶é—´æˆ³å¤„ç†
- æ–‡ä»¶ç´¢å¼•ç®¡ç†

---

## ğŸ”§ å®è·µç»ƒä¹ 

### ç»ƒä¹ 1ï¼šè·Ÿè¸ªRTSPè¿æ¥æµç¨‹
1. å¯åŠ¨è°ƒè¯•æ¨¡å¼
2. ä½¿ç”¨FFmpegå‘å¸ƒRTSPæµ
3. è·Ÿè¸ªä»è¿æ¥åˆ°æ•°æ®ä¼ è¾“çš„å®Œæ•´æµç¨‹

### ç»ƒä¹ 2ï¼šåˆ†æWebRTCè¿æ¥å»ºç«‹
1. åœ¨æµè§ˆå™¨ä¸­è®¿é—®WebRTCé¡µé¢
2. è·Ÿè¸ªICEè¿æ¥å»ºç«‹è¿‡ç¨‹
3. è§‚å¯ŸSDPåå•†è¿‡ç¨‹

### ç»ƒä¹ 3ï¼šé…ç½®çƒ­é‡è½½æµ‹è¯•
1. ä¿®æ”¹é…ç½®æ–‡ä»¶
2. è§‚å¯Ÿé…ç½®é‡è½½è¿‡ç¨‹
3. éªŒè¯æ–°é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

---

## ğŸ“š å­¦ä¹ å»ºè®®

### 1. å¾ªåºæ¸è¿›
- ä»main.goå¼€å§‹ï¼Œé€æ­¥æ·±å…¥å„ä¸ªæ¨¡å—
- æ¯ä¸ªæ¨¡å—éƒ½è¦æœ‰å®è·µéªŒè¯
- ä¿æŒä»£ç é˜…è¯»å’Œå®é™…æ“ä½œçš„å¹³è¡¡

### 2. é‡ç‚¹å…³æ³¨
- **å¹¶å‘å¤„ç†**: ç†è§£Goè¯­è¨€çš„goroutineå’Œchannelä½¿ç”¨
- **åè®®å®ç°**: é‡ç‚¹å­¦ä¹ RTSPå’ŒWebRTCçš„å®ç°
- **é”™è¯¯å¤„ç†**: è§‚å¯Ÿé¡¹ç›®ä¸­çš„é”™è¯¯å¤„ç†ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**: ç†è§£ç¼“å†²åŒºç®¡ç†å’Œå†…å­˜ä½¿ç”¨

### 3. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨VSCodeçš„è°ƒè¯•åŠŸèƒ½è®¾ç½®æ–­ç‚¹
- è§‚å¯Ÿå˜é‡å€¼å’Œè°ƒç”¨æ ˆ
- ä½¿ç”¨æ—¥å¿—è¾“å‡ºè·Ÿè¸ªç¨‹åºæµç¨‹
- åˆ©ç”¨pprofè¿›è¡Œæ€§èƒ½åˆ†æ

### 4. æ‰©å±•å­¦ä¹ 
- é˜…è¯»ç›¸å…³åè®®è§„èŒƒï¼ˆRFCæ–‡æ¡£ï¼‰
- å­¦ä¹ Goè¯­è¨€å¹¶å‘ç¼–ç¨‹æœ€ä½³å®è·µ
- äº†è§£æµåª’ä½“æŠ€æœ¯åŸºç¡€çŸ¥è¯†

---

## ğŸ¯ å­¦ä¹ é‡Œç¨‹ç¢‘

### ç¬¬ä¸€é˜¶æ®µ (1-2å‘¨)
- [ ] ç†è§£ç¨‹åºå¯åŠ¨æµç¨‹
- [ ] æŒæ¡é…ç½®åŠ è½½æœºåˆ¶
- [ ] ç†Ÿæ‚‰Coreæ¶æ„è®¾è®¡

### ç¬¬äºŒé˜¶æ®µ (2-3å‘¨)
- [ ] æ·±å…¥RTSPåè®®å®ç°
- [ ] ç†è§£è·¯å¾„ç®¡ç†ç³»ç»Ÿ
- [ ] æŒæ¡è®¤è¯æœºåˆ¶

### ç¬¬ä¸‰é˜¶æ®µ (2-3å‘¨)
- [ ] å­¦ä¹ WebRTCå®ç°
- [ ] ç†è§£APIç³»ç»Ÿè®¾è®¡
- [ ] æŒæ¡å½•åˆ¶å›æ”¾åŠŸèƒ½

### ç¬¬å››é˜¶æ®µ (1-2å‘¨)
- [ ] æ€§èƒ½ä¼˜åŒ–æŠ€å·§
- [ ] é”™è¯¯å¤„ç†ç­–ç•¥
- [ ] é¡¹ç›®æ‰©å±•æ–¹æ³•

---

## ğŸš€ å¼€å§‹å­¦ä¹ 

ç°åœ¨æ‚¨å¯ä»¥ï¼š

1. **æ‰“å¼€VSCode**ï¼ŒåŠ è½½MediaMTXé¡¹ç›®
2. **è®¾ç½®æ–­ç‚¹**åœ¨ `main.go:10`
3. **å¯åŠ¨è°ƒè¯•**ï¼Œé€‰æ‹©"Debug MediaMTX with Custom Config"
4. **å¼€å§‹è·Ÿè¸ª**ç¨‹åºæ‰§è¡Œæµç¨‹

ç¥æ‚¨å­¦ä¹ æ„‰å¿«ï¼ğŸ‰ 